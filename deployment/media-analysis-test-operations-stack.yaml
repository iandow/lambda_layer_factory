AWSTemplateFormatVersion: "2010-09-09"
Description: (SO0042-workflow) Media Analysis Solution - The AWS CloudFormation template that provisions the Media Analysis Solution test operations resources using Amazon Elasticsearch.

Parameters:
  WorkflowCustomResourceArn:
      Type: String
      Description: "ARN of the Media Analysis custom resource that handles creating operations, stages and workflows"

Mappings:
    SourceCode:
        General:
            S3Bucket: '%%BUCKET_NAME%%'
            KeyPrefix: "media-analysis-solution/%%VERSION%%"

Resources:
  
  # Service - IAM

  TestExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        -
          PolicyName: !Sub "${AWS::StackName}-test-execution-lambda-role"
          PolicyDocument:
            Statement:
              -
                Effect: Allow
                Action:
                  - states:StartExecution
                Resource:
                  - !Join ["", ["arn:aws:states:", Ref: "AWS::Region", ":", Ref: "AWS::AccountId", ":stateMachine:", Ref: "AWS::StackName","-*"]]
              -
                Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Join ["", ["arn:aws:logs:", Ref: "AWS::Region", ":", Ref: "AWS::AccountId", ":log-group:/aws/lambda/*"]]
  # Services - Lambda

  TestVideoOperationLambda:
    Properties:
      FunctionName: !Sub "${AWS::StackName}-test-video"
      Environment:
        Variables:
          Status: "Complete"
      Handler: test.video_test_lambda
      Code:
        S3Bucket: !Join ["-", [!FindInMap ["SourceCode", "General", "S3Bucket"], !Ref "AWS::Region"]]
        S3Key: !Join ["/", [!FindInMap ["SourceCode", "General", "KeyPrefix"],  "test_operations.zip"]]
      MemorySize: 256
      Role:
        Fn::GetAtt:
        - TestExecutionRole
        - Arn
      Runtime: python3.6
      Timeout: 900
    Type: AWS::Lambda::Function 

  TestAudioOperationLambda:
    Properties:
      FunctionName: !Sub "${AWS::StackName}-test-audio"
      Environment:
        Variables:
          Status: "Complete"
      Handler: test.audio_test_lambda
      Code:
        S3Bucket: !Join ["-", [!FindInMap ["SourceCode", "General", "S3Bucket"], !Ref "AWS::Region"]]
        S3Key: !Join ["/", [!FindInMap ["SourceCode", "General", "KeyPrefix"],  "test_operations.zip"]]
      MemorySize: 256
      Role:
        Fn::GetAtt:
        - TestExecutionRole
        - Arn
      Runtime: python3.6
      Timeout: 900
    Type: AWS::Lambda::Function 

# IAM Roles:
  StepFunctionRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action: "sts:AssumeRole"
            Effect: "Allow"
            Principal:
              Service: "states.amazonaws.com"
      Policies:
        - PolicyName: "TestSFNLambdaAccess"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action: "lambda:InvokeFunction"
                Resource: "arn:aws:lambda:*:*:function:*"
                Effect: "Allow"

  
# Operator Base Step function

  TestVideoStepFunction:
    Type: "AWS::StepFunctions::StateMachine"
    Properties:
      StateMachineName: "TestVideoStateMachine"
      DefinitionString: !Sub |-
        {
          "StartAt": "Start Video",
          "States": {
            "Start Video": {
              "Type": "Task",
              "Resource": "${TestVideoOperationLambda.Arn}",
              "End": true
            }
            
          }
        }
      RoleArn: !GetAtt "StepFunctionRole.Arn"

  TestAudioStepFunction:
    Type: "AWS::StepFunctions::StateMachine"
    Properties:
      StateMachineName: "TestAudioStateMachine"
      DefinitionString: !Sub |-
        {
          "StartAt": "Start Audio Test",
          "States": {

            "Start Audio Test": {
              "Type": "Task",
              "Resource": "${TestAudioOperationLambda.Arn}",
              "End": true
            }
            
          }
        }
      RoleArn: !GetAtt "StepFunctionRole.Arn"

  # Build operators 
  TestVideoOperationCustomResource:
    Type: Custom::CustomResource
    Properties:
      ServiceToken: !Ref WorkflowCustomResourceArn
      ResourceType: "Operation"
      name: "test-video-operation"
      configuration: 
          {
            "mediaType": "video",
            "enabled": true
          }
      stateMachineArn: !Ref TestVideoStepFunction
      stateMachineExecutionRoleArn: !GetAtt TestExecutionRole.Arn

  TestVideoStageCustomResource:
    DependsOn: TestVideoOperationCustomResource
    Type: Custom::CustomResource
    Properties:
      ServiceToken: !Ref WorkflowCustomResourceArn
      ResourceType: "Stage"
      name: "test-video-stage"
      operations:
        - test-video-operation
      stateMachineArn: !Ref TestVideoStepFunction
      stateMachineExecutionRoleArn: !GetAtt TestExecutionRole.Arn

  TestVideoWorkflowCustomResource:
    DependsOn: TestVideoStageCustomResource
    Type: Custom::CustomResource
    Properties:
      ServiceToken: !Ref WorkflowCustomResourceArn
      ResourceType: "Workflow"
      name: "TestVideoWorkflow"
      Stages: !Sub |-
        {
          "test-video-stage":
            {
            "End": true
          }
        }
      StartAt: test-video-stage

    # Build stages

    # Build workflows

Outputs:
  TestVideoOperation:
    Description: Video type operation for testing
    Value: !GetAtt "TestVideoOperationCustomResource.name"
  TestVideoStage:
    Value: !GetAtt "TestVideoStageCustomResource.name"
  TestVideoStageStateMachineArn:
    Value: !GetAtt "TestVideoStageCustomResource.stateMachineArn"

